- @title = 'Progress Report'
.content-main-header
  %h1= @title

- user_scope = User.current.where(include_in_exports: true)
- diagnosed_scope = user_scope.where(adult_diagnosed: true)
- report_diagnosed_scope = Report.where(user_is_adult_diagnosed: true, user_id: diagnosed_scope.select(:id))

.content-container
  .content-header
    %h3 Number of members by category
  .content-body
    %table.table.table-bordered.table-condensed{ style: 'table-layout:fixed' }
      %thead
        %tr
          - User::TYPE.each do |name, type|
            %th= name
          %th Total
      %tbody
        %tr
          - total_count = 0
          - User::TYPE.each do |name, type|
            - count = user_scope.where(type.to_sym => true).count
            - total_count += count
            %td= number_with_delimiter count
          %td= number_with_delimiter total_count
    = link_to 'More Breakdown by Category', admin_version_stats_path

.content-container
  .content-header
    %h3 Signed consents (Diagnosed Patients)
  .content-body
    %p.lead.centered-text{ style: 'margin-top: 20px' }
      - signed_consent_count = diagnosed_scope.where.not(accepted_consent_at: nil).count
      - not_signed_consent_count = diagnosed_scope.where(accepted_consent_at: nil).count
      = number_with_delimiter signed_consent_count
      - if false
        Signed Consent
        %br
        = number_with_delimiter not_signed_consent_count

.content-container
  .content-header
    %h3 With any questionnaire data (Diagnosed Patients)
  .content-body
    %p.lead.centered-text{ style: 'margin-top: 20px' }
      - with_questionnaire_count = report_diagnosed_scope.where.not(value: [nil, ""]).uniq.select(:user_id).count
      = number_with_delimiter with_questionnaire_count

.content-container
  .content-header
    %h3 Demographics on signed consents
  .content-body
    - male_count = report_diagnosed_scope.where(survey_slug: 'about-me', question_slug: 'sex', encounter: 'baseline', answer_option_text: 'Male' ).uniq.select(:user_id).count
    - female_count = report_diagnosed_scope.where(survey_slug: 'about-me', question_slug: 'sex', encounter: 'baseline', answer_option_text: 'Female' ).uniq.select(:user_id).count

    %table.table.table-bordered.table-condensed{ style: 'table-layout:fixed' }
      %thead
        %tr
          %th Male
          %th Female
      %tbody
        %tr
          %td= number_with_delimiter male_count
          %td= number_with_delimiter female_count

    - white_count = report_diagnosed_scope.where(survey_slug: 'about-me', question_slug: 'race', encounter: 'baseline', value: '5' ).uniq.select(:user_id).count
    - black_count = report_diagnosed_scope.where(survey_slug: 'about-me', question_slug: 'race', encounter: 'baseline', value: '3' ).uniq.select(:user_id).count

    %table.table.table-bordered.table-condensed{ style: 'table-layout:fixed' }
      %thead
        %tr
          %th White
          %th Black
      %tbody
        %tr
          %td= number_with_delimiter white_count
          %td= number_with_delimiter black_count

    - date_array = report_diagnosed_scope.where(survey_slug: 'about-me', question_slug: 'date-of-birth', encounter: 'baseline' ).pluck(:value).collect{|d| (Date.parse(d) rescue nil)}.compact

    %table.table.table-bordered.table-condensed{ style: 'table-layout:fixed' }
      %thead
        %tr
          %th 18-34
          %th 35-49
          %th 50-64
          %th 65-75
          %th 76+
      %tbody
        %tr
          %td= number_with_delimiter date_array.select{|d| d.in?((Date.today - 34.years)..(Date.today - 18.years))}.count
          %td= number_with_delimiter date_array.select{|d| d.in?((Date.today - 49.years)..(Date.today - 35.years))}.count
          %td= number_with_delimiter date_array.select{|d| d.in?((Date.today - 64.years)..(Date.today - 50.years))}.count
          %td= number_with_delimiter date_array.select{|d| d.in?((Date.today - 75.years)..(Date.today - 65.years))}.count
          %td= number_with_delimiter date_array.select{|d| d < (Date.today - 75.years)}.count

.content-container
  .content-header
    %h3 Number voting on rank research and number of items
  .content-body
    - research_topic_count = ResearchTopic.where.not(topic_id: nil).count
    - vote_count = Vote.current.count

    %table.table.table-bordered.table-condensed{ style: 'table-layout:fixed' }
      %thead
        %tr
          %th Research Topics
          %th Votes
      %tbody
        %tr
          %td= number_with_delimiter research_topic_count
          %td= number_with_delimiter vote_count

.content-container
  .content-header
    %h3 Number of posts topics and unique individuals posting
  .content-body
    - post_scope = Post.current.visible_for_user.not_research
    - post_count = post_scope.count
    - posting_user_count = post_scope.uniq.select(:user_id).count
    - topic_count = Topic.current.where(status: ['pending_review', 'approved']).not_research.count
    %table.table.table-bordered.table-condensed{ style: 'table-layout:fixed' }
      %thead
        %tr
          %th Posts
          %th Topics
          %th Unique Users
      %tbody
        %tr
          %td= number_with_delimiter post_count
          %td= number_with_delimiter topic_count
          %td= number_with_delimiter posting_user_count

.content-container
  .content-header
    %h3 Number of withdrawn consent (Diagnosed Patients)
  .content-body
    %p.lead.centered-text{ style: 'margin-top: 20px' }
      - withdrawn_consent_count = Report.where(user_is_adult_diagnosed: true, user_id: diagnosed_scope.where(accepted_consent_at: nil).select(:id)).where.not(value: [nil, ""]).uniq.select(:user_id).count
      = number_with_delimiter withdrawn_consent_count





