%a.anchor-top{ name: reply.anchor }
%div{ id: "comment-#{reply.id}-container", class: (defined?(level) && level == 0 ? 'content-container' : nil), style: 'position:relative' }
  .reply-container{ class: (defined?(level) && level.even? ? 'reply-even' : 'reply-odd' ) }
    .reply-inner-container
      .reply-avatar{ style: "#{'display:none' if reply.below_threshold?}" }
        - size = 50
        - if reply.deleted?
          = image_tag 'default-user.jpg', alt: '', class: 'user-thumbnail-forum-no-border', style: "max-height:#{(size*2)+5}px;max-width:#{size+5}px;", title: reply.user.forum_name, data: { toggle: 'tooltip', container: 'body', placement: 'top' }
        - else
          = image_tag user_photo_url(reply.user), alt: '', class: 'user-thumbnail-forum-no-border', style: "max-height:#{(size*2)+5}px;max-width:#{size+5}px;", title: reply.user.forum_name, data: { toggle: 'tooltip', container: 'body', placement: 'top' }
          .centered.text-muted{ style: 'font-size: 9px;margin-top:5px' }
            = pluralize(number_with_delimiter(reply.user.replies.count), 'post')
      .reply-header{ data: { parent_comment_id: reply.parent_comment_id, reply_id: reply.id } }
        = render 'replies/header', reply: reply, just_voted: false

      .reply-body{ style: "#{'display:none' if reply.below_threshold?}" }
        %div{ data: { object: 'reply-show', parent_comment_id: reply.parent_comment_id, reply_id: reply.id } }
          = render 'replies/formatted', reply: reply

        - unless reply.deleted?
          - new_reply = @chapter.replies.new(reply_id: reply.id)
          - parent_comment_id = new_reply.parent_comment_id
          - reply_id = (new_reply.new_record? ? 'new' : new_reply.id)
          %div{ id: "write_comment_#{parent_comment_id}_#{reply_id}" }
            %small= link_to 'reply', async_chapter_reply_path(chapter_id: @chapter, parent_comment_id: parent_comment_id, reply_id: reply_id), method: :post, remote: true, class: 'text-muted'
            - if current_user && reply.editable_by?(current_user)
              %small= link_to 'edit', edit_reply_path(reply, chapter_id: @chapter), remote: true, class: 'text-muted'
              %small= link_to 'delete', reply_path(reply, chapter_id: @chapter), method: :delete, remote: true, data: { confirm: 'Are you sure you want to delete this comment?' }, class: 'text-muted'


          %div{ id: "comment_container_#{parent_comment_id}_#{reply_id}", style: 'display:none' }

        - reply_scope = @chapter.replies.where(reply_id: reply.id)

        - if params[:sort_by] == 'new'
          - reply_scope = reply_scope.order(id: :desc)
        - elsif params[:sort_by] == 'best'
          - reply_scope = reply_scope.order(:id)
        - else
          - reply_scope = reply_scope.order(:id)
        - reply_scope.each do |child_comment|
          = render 'replies/show', reply: child_comment, level: defined?(level) ? level + 1 : 0
