%div{ class: (defined?(level) && level == 0 ? 'content-container' : nil) }
  %a.anchor-top{ name: "comment-#{reply.id}" }
  .broadcast-comment{ class: (defined?(level) && level.even? ? 'broadcast-comment-even' : 'broadcast-comment-odd' ) }
    .broadcast-comment-header{ data: { parent_comment_id: reply.parent_comment_id, reply_id: reply.id } }
      = render 'replies/header', reply: reply, just_voted: false

    .broadcast-comment-body{ style: "#{'display:none' if reply.below_threshold?}" }
      %div{ data: { object: 'reply-show', parent_comment_id: reply.parent_comment_id, reply_id: reply.id } }
        = render 'replies/formatted', reply: reply

      - unless reply.deleted?
        - new_reply = @chapter.replies.new(reply_id: reply.id)
        - parent_comment_id = new_reply.parent_comment_id
        - reply_id = (new_reply.new_record? ? 'new' : new_reply.id)
        %div{ id: "write_comment_#{parent_comment_id}_#{reply_id}" }
          %small= link_to 'reply', async_chapter_reply_path(chapter_id: @chapter, parent_comment_id: parent_comment_id, reply_id: reply_id), method: :post, remote: true, class: 'text-muted'
          - if current_user && reply.editable_by?(current_user)
            %small= link_to 'edit', edit_reply_path(reply, chapter_id: @chapter), remote: true, class: 'text-muted'
            %small= link_to 'delete', reply_path(reply, chapter_id: @chapter), method: :delete, remote: true, data: { confirm: 'Are you sure you want to delete this comment?' }, class: 'text-muted'


        %div{ id: "comment_container_#{parent_comment_id}_#{reply_id}", style: 'display:none' }

      - reply_scope = @chapter.replies.where(reply_id: reply.id)

      - if params[:sort_by] == 'new'
        - reply_scope = reply_scope.order(id: :desc)
      - elsif params[:sort_by] == 'best'
        - reply_scope = reply_scope.order(:id)
      - else
        - reply_scope = reply_scope.order(:id)
      - reply_scope.each do |child_comment|
        = render 'replies/show', reply: child_comment, level: defined?(level) ? level + 1 : 0
